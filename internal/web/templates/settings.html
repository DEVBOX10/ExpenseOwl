<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/fa.min.css">
    <link rel="stylesheet" href="/style.css">
    <title>ExpenseOwl Settings</title>
</head>
<body>
    <div class="container">
        <header>
            <div class="nav-bar">
                <a href="/">
                    <img src="/pwa/icon-512.png" alt="ExpenseOwl Logo" height="85" style="vertical-align: middle; margin-right: 20px;">
                </a>
                <a href="/" class="view-button" data-tooltip="Dashboard">
                    <i class="fa-solid fa-chart-pie"></i>
                </a>
                <a href="/table" class="view-button" data-tooltip="Table View">
                    <i class="fa-solid fa-table"></i>
                </a>
                <a href="/settings" class="view-button active" data-tooltip="Settings">
                    <i class="fa-solid fa-gear"></i>
                </a>
            </div>
        </header>

        <div class="info-field">
            Version: <a id="version-link" href="https://github.com/tanq16/expenseowl/releases" target="_blank" rel="noopener noreferrer">dev</a>
            <span class="separator">|</span>
            <a href="https://github.com/tanq16/expenseowl/blob/main/README.md" target="_blank" rel="noopener noreferrer">Documentation</a>
            <span class="separator">|</span>
            <a href="https://github.com/tanq16/expenseowl" target="_blank" rel="noopener noreferrer">GitHub</a>
        </div>

        <div class="form-container">
            <h2 align="center">Category Settings</h2>
            <div id="categories-manager">
                <div id="categories-list" class="categories-list">
                </div>
                <div class="category-input-container">
                    <input type="text" id="newCategory" placeholder="Add new category">
                    <button id="addCategory" class="nav-button">Add</button>
                </div>
                <button id="saveCategories" class="nav-button">Save Categories</button>
                <div id="categoriesMessage" class="form-message"></div>
            </div>
        </div>

        <div class="settings-container">
            <div class="form-container half-width">
                <h2 align="center">Currency Settings</h2>
                <div class="currency-selector">
                    <select id="currencySelect">
                    </select>
                    <button id="saveCurrency" class="nav-button">Save</button>
                </div>
                <div id="currencyMessage" class="form-message"></div>
            </div>
            
            <div class="form-container half-width">
                <h2 align="center">Start Date Settings</h2>
                <div class="start-date-manager">
                    <input type="number" id="startDate" min="1" max="31" placeholder="1">
                    <button id="saveStartDate" class="nav-button">Save</button>
                </div>
                <div id="startDateMessage" class="form-message"></div>
            </div>
        </div>

        <div class="form-container">
            <h2 align="center">Import/Export Data</h2>
            <div class="export-buttons">
                <!-- <a href="/export/csv" class="nav-button" download="expenses.csv">
                    <i class="fa-solid fa-file-csv"></i> Export CSV
                </a>
                <a href="/export/json" class="nav-button" download="expenses.json">
                    <i class="fa-solid fa-file-code"></i> Export JSON
                </a>
                <label for="csvFile" class="nav-button">
                    <i class="fa-solid fa-file-csv"></i> Import CSV
                </label>
                <input type="file" id="csvFile" accept=".csv" style="display: none;">
                <label for="jsonFile" class="nav-button">
                    <i class="fa-solid fa-file-code"></i> Import JSON
                </label>
                <input type="file" id="jsonFile" accept=".json" style="display: none;"> -->
            </div>
            <div id="importMessage" class="form-message"></div>
            <div id="importSummary" class="import-summary" style="display: none;"></div>
        </div>
    </div>

    <script>
        const currencyBehaviors = {
            "usd": { symbol: "$", useComma: false, useDecimals: true },
            "eur": { symbol: "€", useComma: true, useDecimals: true },
            "gbp": { symbol: "£", useComma: false, useDecimals: true },
            "jpy": { symbol: "¥", useComma: false, useDecimals: false },
            "cny": { symbol: "¥", useComma: false, useDecimals: true },
            "krw": { symbol: "₩", useComma: false, useDecimals: false },
            "inr": { symbol: "₹", useComma: false, useDecimals: true },
            "rub": { symbol: "₽", useComma: true, useDecimals: true },
            "brl": { symbol: "R$", useComma: true, useDecimals: true },
            "zar": { symbol: "R", useComma: false, useDecimals: true },
            "aed": { symbol: "AED", useComma: false, useDecimals: true },
            "aud": { symbol: "A$", useComma: false, useDecimals: true },
            "cad": { symbol: "C$", useComma: false, useDecimals: true },
            "chf": { symbol: "Fr", useComma: false, useDecimals: true },
            "hkd": { symbol: "HK$", useComma: false, useDecimals: true },
            "sgd": { symbol: "S$", useComma: false, useDecimals: true },
            "thb": { symbol: "฿", useComma: false, useDecimals: true },
            "try": { symbol: "₺", useComma: true, useDecimals: true },
            "mxn": { symbol: "Mex$", useComma: false, useDecimals: true },
            "php": { symbol: "₱", useComma: false, useDecimals: true },
            "pln": { symbol: "zł", useComma: true, useDecimals: true },
            "sek": { symbol: "kr", useComma: false, useDecimals: true },
            "nzd": { symbol: "NZ$", useComma: false, useDecimals: true },
            "dkk": { symbol: "kr.", useComma: true, useDecimals: true },
            "idr": { symbol: "Rp", useComma: false, useDecimals: true },
            "ils": { symbol: "₪", useComma: false, useDecimals: true },
            "vnd": { symbol: "₫", useComma: true, useDecimals: false },
            "myr": { symbol: "RM", useComma: false, useDecimals: true },
        };

        let categories = [];
        let currentCurrency = "usd";
        let currentStartDate = 1;
        let draggedItem = null;

        function showMessage(elementId, message, isSuccess) {
            const messageDiv = document.getElementById(elementId);
            messageDiv.textContent = message;
            messageDiv.className = isSuccess ? 'form-message success' : 'form-message error';
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = 'form-message';
            }, 3000);
        }

        function renderCategories() {
            const list = document.getElementById('categories-list');
            list.innerHTML = '';
            categories.forEach((category, index) => {
                const item = document.createElement('div');
                item.className = 'category-item';
                item.draggable = true;
                item.dataset.index = index;
                item.innerHTML = `
                    <div class="category-handle-area">
                        <span class="drag-handle"><i class="fa-solid fa-grip-lines"></i></span>
                        <span>${category}</span>
                    </div>
                    <button class="delete-button" onclick="removeCategory(${index})">
                        <i class="fa-solid fa-times"></i>
                    </button>
                `;
                
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('drop', handleDrop);
                
                list.appendChild(item);
            });
        }

        function handleDragStart(e) {
            this.classList.add('dragging');
            draggedItem = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            removePlaceholders();
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
            if (this === draggedItem) return false;
            const rect = this.getBoundingClientRect();
            const clientY = e.clientY;
            const threshold = rect.top + (rect.height / 2);
            const isBefore = clientY < threshold;
            removePlaceholders();
            const placeholder = document.createElement('div');
            placeholder.className = 'placeholder';
            if (isBefore) {
                this.parentNode.insertBefore(placeholder, this);
            } else {
                this.parentNode.insertBefore(placeholder, this.nextSibling);
            }
            return false;
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.category-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            removePlaceholders();
        }
        
        function removePlaceholders() {
            document.querySelectorAll('.placeholder').forEach(placeholder => {
                placeholder.remove();
            });
        }

        function handleDrop(e) {
            e.stopPropagation();
            e.preventDefault();
            removePlaceholders();
            if (draggedItem !== this) {
                const fromIndex = parseInt(draggedItem.dataset.index, 10);
                let toIndex = parseInt(this.dataset.index, 10);
                
                const rect = this.getBoundingClientRect();
                const clientY = e.clientY;
                const threshold = rect.top + (rect.height / 2);
                const isBefore = clientY < threshold;

                if (!isBefore) {
                    toIndex++;
                }
                if (fromIndex < toIndex) {
                    toIndex--;
                }

                const movedItem = categories.splice(fromIndex, 1)[0];
                categories.splice(toIndex, 0, movedItem);
                renderCategories();
            }
            return false;
        }

        function addCategory() {
            const input = document.getElementById('newCategory');
            const category = input.value.trim();
            if (category && !categories.includes(category)) {
                categories.push(category);
                renderCategories();
                input.value = '';
            } else if (categories.includes(category)) {
                showMessage('categoriesMessage', 'Category already exists', false);
            }
        }

        function removeCategory(index) {
            categories.splice(index, 1);
            renderCategories();
        }

        async function saveCategories() {
            if (categories.length === 0) {
                showMessage('categoriesMessage', 'At least one category is required', false);
                return;
            }
            try {
                const response = await fetch('/categories/edit', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(categories)
                });   
                if (response.ok) {
                    showMessage('categoriesMessage', 'Categories saved successfully', true);
                } else {
                    showMessage('categoriesMessage', 'Failed to save categories', false);
                }
            } catch (error) {
                console.error('Error saving categories:', error);
                showMessage('categoriesMessage', 'Error saving categories', false);
            }
        }

        function populateCurrencySelect() {
            const select = document.getElementById('currencySelect');
            select.innerHTML = '';
            for (const code in currencyBehaviors) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${code.toUpperCase()} (${currencyBehaviors[code].symbol})`;
                if (code === currentCurrency) {
                    option.selected = true;
                }
                select.appendChild(option);
            }
        }
        
        async function saveCurrency() {
            const currencyCode = document.getElementById('currencySelect').value;
            try {
                const response = await fetch('/currency', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currencyCode)
                });
                if (response.ok) {
                    showMessage('currencyMessage', 'Currency saved successfully', true);
                    currentCurrency = currencyCode;
                } else {
                    showMessage('currencyMessage', 'Failed to save currency', false);
                }
            } catch (error) {
                console.error('Error saving currency:', error);
                showMessage('currencyMessage', 'Error saving currency', false);
            }
        }

        function populateStartDateInput() {
            const input = document.getElementById("startDate");
            input.value = currentStartDate;
        }

        async function saveStartDate() {
            const startDateValue = document.getElementById("startDate").value;
            try {
                const response = await fetch('/startdate', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(parseInt(startDateValue, 10))
                });
                if (response.ok) {
                    showMessage('startDateMessage', 'Start date saved successfully', true);
                } else {
                    showMessage('startDateMessage', 'Failed to save start date', false);
                }
            } catch (error) {
                console.error('Error saving start date:', error);
                showMessage('startDateMessage', 'Error saving start date', false);
            }
        }

        async function initialize() {
            try {
                const response = await fetch('/config');
                if (!response.ok) {
                    throw new Error('Failed to fetch configuration');
                }
                const config = await response.json();
                categories = [...config.categories];
                currentCurrency = config.currency;
                currentStartDate = config.startDate;
                
                renderCategories();
                populateCurrencySelect();
                populateStartDateInput();

                fetch('/version').then(response => {
                    if (response.ok) return response.text();
                    throw new Error('Network response was not ok.');
                }).then(version => {
                    const versionLink = document.getElementById('version-link');
                    versionLink.textContent = version;
                    if (version !== 'dev') {
                        versionLink.href = `https://github.com/tanq16/expenseowl/releases/tag/${version}`;
                    }
                }).catch(error => {
                    console.error('Failed to fetch version:', error);
                });

            } catch (error) {
                console.error('Failed to initialize settings:', error);
                showMessage('categoriesMessage', 'Failed to load settings', false);
            }
        }

        async function handleFileUpload(e) {
            // This part is commented out as per instructions
        }

        document.getElementById('addCategory').addEventListener('click', addCategory);
        document.getElementById('saveCategories').addEventListener('click', saveCategories);
        document.getElementById('saveCurrency').addEventListener('click', saveCurrency);
        document.getElementById('saveStartDate').addEventListener('click', saveStartDate);
        // document.getElementById('csvFile').addEventListener('change', handleFileUpload);
        // document.getElementById('jsonFile').addEventListener('change', handleFileUpload);
        document.getElementById('newCategory').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addCategory();
            }
        });

        document.addEventListener('DOMContentLoaded', initialize);
        window.removeCategory = removeCategory;
    </script>
</body>
</html>
